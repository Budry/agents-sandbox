---
-   name: Provision Debian 13 server
    hosts: servers
    become: true
    vars:
        sandbox_image: docker-registry.zaruba-ondrej.dev/codex-sandbox
        sandbox_registry_host: "{{ sandbox_image.split('/')[0] }}"
    vars_prompt:
        -   name: registry_user
            prompt: "Docker registry username"
            private: false
        -   name: registry_pass
            prompt: "Docker registry password"
            private: true

    tasks:
        -   name: Update apt cache
            ansible.builtin.apt:
                update_cache: true
                cache_valid_time: 3600

        -   name: Install base packages
            ansible.builtin.apt:
                name:
                    - ca-certificates
                    - curl
                    - gnupg
                    - lsb-release
                    - openssh-client
                    - openssh-server
                    - vim
                    - git
                    - sudo
                    - acl
                state: present

        -   name: Ensure ssh service is enabled
            ansible.builtin.service:
                name: ssh
                state: started
                enabled: true

        -   name: Ensure apt keyrings directory exists
            ansible.builtin.file:
                path: /etc/apt/keyrings
                state: directory
                mode: "0755"

        -   name: Add Docker GPG key
            ansible.builtin.get_url:
                url: https://download.docker.com/linux/debian/gpg
                dest: /etc/apt/keyrings/docker.gpg
                mode: "0644"

        -   name: Add Docker apt repository
            ansible.builtin.apt_repository:
                repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
                state: present

        -   name: Install Docker Engine and Compose plugin
            ansible.builtin.apt:
                name:
                    - docker-ce
                    - docker-ce-cli
                    - containerd.io
                    - docker-buildx-plugin
                    - docker-compose-plugin
                state: present
                update_cache: true

        -   name: Enable Docker service
            ansible.builtin.service:
                name: docker
                state: started
                enabled: true

        -   name: Pull latest sandbox image with ephemeral registry auth
            ansible.builtin.shell: |
                set -euo pipefail
                tmp_config="$(mktemp -d)"
                cleanup() {
                    rm -rf "${tmp_config}"
                }
                trap cleanup EXIT
                export DOCKER_CONFIG="${tmp_config}"
                printf '%s\n' "$REGISTRY_PASS" | docker login "{{ sandbox_registry_host }}" -u "$REGISTRY_USER" --password-stdin >/dev/null
                docker pull "{{ sandbox_image }}"
            args:
                executable: /bin/bash
            environment:
                REGISTRY_USER: "{{ registry_user }}"
                REGISTRY_PASS: "{{ registry_pass }}"
            no_log: true

        -   name: Add SSH public keys for the remote user
            ansible.builtin.authorized_key:
                user: "{{ ansible_user }}"
                key: "{{ lookup('file', lookup('env','HOME') + '/.ssh/id_ed25519.pub') }}"
                state: present

        -   name: Ensure .ssh directory exists for remote user
            ansible.builtin.file:
                path: "/home/{{ ansible_user }}/.ssh"
                state: directory
                owner: "{{ ansible_user }}"
                group: "{{ ansible_user }}"
                mode: "0700"
            when: ansible_user is defined

        -   name: Generate dedicated sandbox SSH key for remote user
            ansible.builtin.command:
                cmd: ssh-keygen -t ed25519 -a 64 -N '' -f /home/{{ ansible_user }}/.ssh/codex_sandbox_ed25519
                creates: /home/{{ ansible_user }}/.ssh/codex_sandbox_ed25519
            become_user: "{{ ansible_user }}"
            when: ansible_user is defined

        -   name: Add remote user to docker group
            ansible.builtin.user:
                name: "{{ ansible_user }}"
                groups: docker
                append: true
            when: ansible_user is defined

        -   name: Copy .codex directory to user home
            ansible.builtin.copy:
                src: ../.codex
                dest: "/home/{{ ansible_user }}/"
                owner: "{{ ansible_user }}"
                group: "{{ ansible_user }}"
                mode: "0644"
                directory_mode: "0755"
            when: ansible_user is defined

        -   name: Install docker-pull-session command
            ansible.builtin.copy:
                src: ../scripts/docker-pull-session.sh
                dest: /usr/local/bin/docker-pull-session
                mode: "0755"

        -   name: Install docker-push-session command
            ansible.builtin.copy:
                src: ../scripts/docker-push-session.sh
                dest: /usr/local/bin/docker-push-session
                mode: "0755"

        -   name: Install agent-sandbox script
            ansible.builtin.copy:
                src: ../agent-sandbox.sh
                dest: /usr/local/bin/agent-sandbox
                mode: "0755"
